# Backlog

- Improve Shazam signal collection: replace hardcoded sleeps with a more robust pacing/flow strategy to avoid missing matches.
- Observation: some runs show 1:1 request/response balance (e.g., 303/303 with finishedFeeding=1); keep monitoring. Example file: `/Users/till/Music/Music2Go/Media.localized/Magician On Duty/Bucht der Träumer 2024 [Saga Stage]/01 Magician On Duty @@ Bucht der Träumer 2024 [Saga Stage].mp3`.
- Observation: another run ended 381 requests / 380 responses (finishedFeeding=1). Example file: `/Users/till/Music/Music2Go/Media.localized/Frida Darko/Unknown Album/Frida Darko & Atric @ Tanzwüste - Fusion Festival 2025.m4a`.
- WIS baseline metrics (locked defaults): Goodbye 0.824/0.737 (precision/recall), HALO 2024 0.783/0.750, Citizen Kain 0.652/0.714, Frida/Atric 0.760/0.475; recoverable-missed: 1/14, 4/21, 1/14, 11/27.
- WIS duration-default change (short=60, mid=120, short_factor=0.15, mid_factor=0.45) regressed Goodbye/Fusion; reverted.
- WIS span bonus (span_scale=180, span_floor=0.5) improves precision without recall regressions: Goodbye 0.765/0.684 (rm 2/14), HALO 2024 0.783/0.750 (rm 4/21), Citizen Kain 0.682/0.714 (rm 1/14), Frida/Atric 0.783/0.450 (rm 12/27).
- Default alignment fix: `Scripts/refine_experiments.py` now uses WIS defaults (support_scale=6, support_floor=0.3, span_scale=180, span_floor=0.5). Current metrics: Goodbye 0.765/0.684 (rm 2/14), HALO 2024 0.783/0.750 (rm 4/21), Citizen Kain 0.682/0.714 (rm 1/14), Frida/Atric 0.760/0.475 (rm 11/27).
- Cleanup: remove temporary `[Detect] didFindMatch responses/requests` log once signal-baseline comparisons are done.
- Refactor: align beat-detection, key-detection, and track-detection producer/consumer flow with the GCD-based decoding pattern (replace condition-variable approach).
- Hop size experiment summary: tested 8s, 4s, 2s, 1s, 0.25s, 0.125s, 0.0625s, and 1024-frame hops; golden recall unchanged across runs. Default back to 4096-frame hop for stability.
- ShazamKit signature duration limit: catalog accepts 3.0–12.0s; durations beyond that trigger Code=201 ("signature duration is outside the valid range").
- Assumption: stereo vs mono likely does not affect ShazamKit matching (expected internal downmix); defer explicit A/B until needed.
- Observation: hop size and signature window size showed no meaningful impact on golden recall in current tests; treat as low-impact knobs.
- Input capture regression: Patrice 2024 input quality collapsed (unknowns ~2% → ~51%, unique keys 118 → 44, recall 0.79 → 0.33). Inputs archived in `Training/input_regression_patrice_2024.md` with eval outputs and file dates for later traceability.
- Patrice 2024: recall improved while precision dropped; likely refiner/normalization permissiveness rather than signal quality regression. See `Training/input_regression_patrice_2024.md`.
- Goodbye: precision and recall both regressed vs old baseline (0.737 → 0.526). See `Training/input_regression_goodbye.md`.
- Draft ShazamKit feedback email (observations + questions); decide whether to send.
- Explore custom ShazamKit catalog idea (reference signatures + metadata/timecodes) for known sets to improve track/time mapping.
- UI: TrackListController sometimes fails to show progress after “Detect Tracklist”; only ActivityController (and chaser) indicate ongoing work. Investigate progress propagation/update timing. Example: Activity shows “Tracklist Detection — Atric & Frida Darko - Elevate” while TrackListController stays idle (screenshot 2026-01-02 16:10). Added observation: when clicking detect button, TrackListController state flashes briefly, then seems overwritten by another row’s update (possibly tied to Activity updates or row reload order). Confirmation: when nothing else is active, TrackListController progress appears; when Activity updates are ongoing, TrackListController progress is overwritten (see screenshot 2026-01-02 16:22).
- UI: ActivityController rotary progress should use segmented CRT look (orange + bloom) by bending the vertical bars from `LargeRastaPattern_40x10.png` into a circular mask; interpret “bending” as fanning the bars into radial wedges around the ring.
- Shazam “Cosmjn” variability: not a confirmed regression. Short clip (`Training/short_with_cosmjn.mp3`, log `Training/new_showing_it.txt`) shows Cosmjn in delegate/`[ShazamRaw]`/final; long run (`Training/shazamraw_goodbye_newcode_20260102.txt`) shows no Cosmjn in raw around the same window, with different returned tracks. Treat as context‑dependent recognition variability; re‑investigate only if recurrence grows.
- Repro artifact: archived old main app at `Training/PlayEm_OldMain.zip` for regression comparisons.
- Logs archived at `Training/archive_20260102/` (old app short runs, new code short/long runs, long processed runs, misc noise tests, and raw Shazam captures).

- TODO: Add sanitizer cleanup checklist (remove debug flags, temporary maps, unused helpers) after feature work; ensure future sessions log leftovers automatically.
- TODO: Apply the cleanup checklist whenever switching areas: normalize logging flags, delete temporary maps/helpers, prune dead code/tests, and note any leftovers explicitly in BACKLOG.md before moving on.
- Note: Town Joker/Niconé mojibake is irreversible; we chose the mechanical decode (è). If future bias is desired (“exit for heroes”), decide on a heuristic/override or diacritic-stripping fallback before changing expectations.
- TODO: When modifying sanitizer logic, update the header doc to reflect the current pipeline and logging flags (DEBUG_SANITIZER) before moving on.
- Code style (machine-wide reminders):
  - Pointer asterisk binds to the type (`float* p`), apply consistently.
  - Function/method opening brace on the next line; control-flow blocks (if/for/while) keep the brace on the same line but always use braces (no single-line, brace-less blocks). Applies to Objective-C, C++, and C.
- Clang-format: added repo-wide config (4-space indents, 160 cols, Allman for functions/methods only, include sorting with Foundation → other system → PlayEm → project) and `Scripts/clang_format.sh` to format .h/.hpp/.m/.mm.
- AudioQueue backend: visual playhead jumps on pause/resume. Likely because the queue has already pulled buffered frames when pausing (currentFrame reflects queued sampleTime). On resume we reset baseFrame and visuals snap back. Possible fixes: track last confirmed played frame (not queued sampleTime) for visuals, or flush/re-prime on pause to align queue with the visual playhead.
- Header template: use `PlayEmCore/Docs/HEADER_TEMPLATE.txt` or `Scripts/new_header.sh` for new files; DocC comments per rule (/// summary, blank only before Parameters/Returns). Always apply the standard PlayEm header with Till Toenshoff + current date + copyright.

- TODO: FFT visualizer performance—explore a branch to keep the “lower-half” look but reduce FFT cost (smaller FFT plus controlled remap) without affecting visuals; current code still uses the larger FFT and discards the top band.
- TODO: Audit current NotificationCenter vs delegation usage; prefer delegation for direct 1:1 action flows and keep notifications only where fan-out/loose coupling is needed.
- TODO/Idea: Sneaky streaming visualization – optionally flip system default output to a loopback (e.g., BlackHole), let MusicKit playback route there, tap the loopback to visualize streamed content, then restore the original device. Needs opt-in UI, failure handling, and policy review.
- BIG TODO: Replace all GPL-linked dependencies/code with permissive alternatives to enable future App Store submission and avoid GPL obligations.
- HIGH PRIORITY (today): Refactor playback state ownership to a single source of truth (sample/metadata). Stop caching LazySample/metadata in multiple controllers; have listeners observe one owner (AudioController or a playback store) and fetch current sample/metadata on change via a single notification/delegate path.
- Process hygiene: avoid resurfacing resolved issues without justification; keep backlog/status in sync to prevent rehashing closed items.
- Machine-wide note: Xcode builds from the assistant session are unreliable—DerivedData is not writable here and code signing fails; disabling signing lets builds run but then execution/signature breaks. Outcome: user should trigger Xcode builds/tests; assistant should prototype in Python first, then translate to Objective-C/Swift; avoid chasing signing fixes.
- Machine-wide note: ripgrep is available; use `rg`/`rg --files` as default. Avoid re-checking its syntax; remember flags and usage to prevent churn.
- TODO: Ensure new files carry the standard header (filename, PlayEm, created by Till Toenshoff with date, and copyright).
- Code docs: Objective-C/Objective-C++ headers should use DocC-style comments (`///` summary, blank line, `- Parameters:`/`- Returns:` as needed) for API documentation.
- TODO: Prefer async APIs by default for UI-triggered work; UI must never hang. Offload library imports/scans, metadata loads, and heavy operations to background queues with main-thread UI updates only.
- Style note: Let the code breathe—use intentional blank lines to separate logical blocks for readability. Keep guard/early-return blocks together, then add spacing between each cohesive step (collect, filter, remove, append, sort, etc.) to improve scanability.

- Feature idea: add VST3 effect hosting (audio FX only, no instruments/MIDI). Scope: scan/load VST3 bundles, host IAudioProcessor/Controller for audio in/out, expose parameters (UI + state save/restore), optional editor embedding, map buffers into process(), minimal process context (tempo optional), and crash-safe scanning/instantiation.
- Library persistence (planned lightweight DB cache):
  - Keep current in-memory model; add SQLite (or similar) as a metadata cache/source-of-truth with a thin async wrapper (no Core Data).
  - Schema: mirror `MediaMetaData` fields. Tracks keyed by file URL (UNIQUE), with file info (url, file_size, file_mtime, content_hash optional, imported_from persistentID), plus metadata columns: title, artist, album, albumArtist, genre, year, trackNumber, trackCount, discNumber, discCount, duration, bpm, key, rating, comments/notes, tags, compilation flag, artwork_hash/artwork_path (or blob pointer), added_at, last_seen, deleted_flag. Add indices on url, artist/album/title, bpm/key, artwork_hash. Add FTS table for text search over title/artist/album/comments/tags.
  - Import path: pull ITLibrary into DB once, then load from DB on launch; incremental sync keeps in-memory + DB aligned.
  - Change detection: watch music folders via FSEvents and/or periodic sweep; if missing/mtime/size/hash differ, rescan tags and update DB + in-memory entry.
  - Keep artwork/thumb cache separate (file cache keyed by hash/URL); migrations via simple schema versioning.
  - Tracklists: a meta entry can own a tracklist (array of `TimedMediaMetaData`). Persist as a child table keyed by parent track URL + frame with columns: parent_url FK, frame, endFrame, confidence, score, supportCount, and either embedded child meta columns or a FK to another track row (for matched content). Ensure load/write helpers serialize/deserialize the tracklist alongside the parent meta.

- Wave visuals/coarse rendering: multiple attempts caused UI stalls and zero-filled coarse data. Root cause: coarse sampling ran during decode; `rawSampleFromFrameOffset` returned zeros when pages weren’t decoded yet, and segments were marked built. Best-known stable approach is the old baseline (non-progressive coarse). Future attempt should:
  - Keep `rawSample` non-blocking only while decoding; after decode complete it must deliver real PCM.
  - Trigger coarse once decode completes; avoid progress-time builds until a safe retry loop exists.
  - Mark coarse segments built only when real samples were read; skipped segments should retry instead of being marked built with placeholders.
  - WaveViewController already has per-range coarse invalidation to limit redraws.
- AcceleratedBiquadFilter refactor: now uses per-instance coeff storage, cleans up vDSP setup in dealloc, and expects deinterleaved buffers via `applyToInputs`. Added tests with `MockLazySample` to sanity-check mono/stereo cases; callers must supply per-channel pointers. No further issues pending.
- Audio playback timing: playtime display should be multiplied by the current tempo factor (time-stretch) so UI reflects adjusted duration/progress.
- Multi-device output (synchronized): plan if we pursue later:
  - Use a CoreAudio Aggregate (or Multi-Output) device to get a single HAL endpoint; pick the master clock (best accuracy device).
  - CoreAudio rate-matches secondary devices to the master; app must still compensate fixed per-device latency (hardware + buffer) with per-output delay.
  - Collect latencies via `AudioObject` properties; apply offsets in the graph or via device channel delays; adjust if device/settings change.
  - UX: allow selecting devices to aggregate; handle hot-plug and sample-rate mismatches gracefully; tear down if any device disappears.
  - AirPlay multiroom is not exposed; rely on system-selected AirPlay group instead of app-managed grouping.
- Bug: ShazamKit rejects signature duration ~2.999s (Code=201, valid range 3.0–12.0). Seeing `didNotFindMatchForSignature` with duration 2.999547; need to ensure signatures meet the minimum duration (pad/extend capture window).
